name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL（示例：https://github.com/BlissRoms-x86/manifest.git）'
        required: true
        default: 'https://github.com/BlissRoms-x86/manifest.git' # 修正：默认填完整示例地址
      manifest_branch:
        description: '源码分支（优先使用 universe-x86）'
        required: true
        default: 'universe-x86' # 核心修正：2026 年实际存在分支
      prune_repo:
        description: '清理 .repo 释放空间（必须填 true，否则磁盘不足）'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 验证输入合法性
        run: |
          set -euo pipefail
          # 验证 Manifest URL 格式（必须包含 https:// 和 .git）
          if ! [[ "$MANIFEST_URL" =~ ^https://.*\.git$ ]]; then
            echo "错误：请填写完整的 HTTPS 仓库地址（示例：https://github.com/BlissRoms-x86/manifest.git）"
            exit 1
          fi

      - name: 2. 极大化磁盘空间（清理冗余工具）
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          swap-storage: false # 禁用交换分区，避免编译卡顿

      - name: 3. 安装工具链与修复 Repo（2026 路径修正版）
        run: |
          set -euo pipefail
          sudo apt update && sudo apt f
