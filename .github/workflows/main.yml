name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL'
        required: true
        # 修正建议：启动时请输入 github.com
        default: 'github.com'
      manifest_branch:
        description: '源码分支'
        required: true
        # 【核心修正】：默认值改为远程存在的 universe-x86
        default: 'universe-x86'
      prune_repo:
        description: '清理磁盘释放空间 (必须填 true)'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 验证输入合法性
        run: |
          set -euo pipefail
          if [[ "$MANIFEST_URL" == "github.com" || -z "$MANIFEST_URL" ]]; then
            echo "错误：请填写完整的 https 仓库地址，不能只填 github.com"
            exit 1
          fi

      - name: 2. 极大化磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true

      - name: 3. 安装工具链与修复 Repo (2026 路径修正版)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential curl git gnupg gperf libxml2-utils
          make python3 zip zlib1g-dev libssl-dev ccache xmlstarlet gettext xorriso genisoimage


          mkdir -p "$HOME/bin"
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > "$HOME/bin/repo"
          
          if grep -q "<!DOCTYPE html>" "$HOME/bin/repo"; then
            echo "Google 源不可用，切换至 GitHub Raw 原始脚本路径..."
            curl -fsSL raw.githubusercontent.com > "$HOME/bin/repo"
          fi
          
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo || true

        
      - name: 初始化并同步源码 (选择 14.x 分支)
        # 这是官方 Manifest 地址
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          mkdir bliss && cd bliss
          repo init -u "$MANIFEST_URL" -b universe-x86 --depth=1 || \
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

      - name: 开始编译 ISO 镜像
        # 配置为 FOSS (自由开源应用) 并开始制作可启动 ISO
        run: |
          cd bliss
          source build/envsetup.sh
          export BLISS_BUILD_VARIANT=foss # 构建 FOSS 版本，节省空间和时间
          lunch android_x86_64-userdebug
          make iso_img -j$(nproc --all) # 生成 ISO 文件

      - name: 上传生成的 ISO 成品
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-x86_64-FOSS
          path: bliss/out/target/product/x86_64/*.iso
