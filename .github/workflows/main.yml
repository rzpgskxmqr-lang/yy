# Build BlissOS 17 (Surface i1135G7 Optimized) — safer template
name: Build BlissOS 17 (Surface i1135G7 Optimized)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: 'Manifest 仓库 URL（必须填写完整 URL，例如 https://github.com/YourOrg/manifest.git 或 git@github.com:YourOrg/manifest.git）'
        required: true
        default: ''
      manifest_branch:
        description: 'Manifest 分支（默认: bliss-v17.x）'
        required: false
        default: 'bliss-v17.x'
      houdini_repo:
        description: 'Houdini 仓库 URL（可选，留空表示跳过）'
        required: false
        default: ''
      prune_repo:
        description: '是否删除 .repo 释放磁盘（危险，默认 false）。设置为 true 才会删除'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      HOUDINI_REPO: ${{ github.event.inputs.houdini_repo }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}
      TARGET_PRODUCT: "bliss_x86_64"
      BUILD_VARIANT: "userdebug"
      CCACHE_DIR: ${{ runner.temp }}/ccache

    steps:
      - name: actions/checkout (optional)
        uses: actions/checkout@v4

      - name: 验证输入（防止占位符/误填）
        run: |
          set -euo pipefail
          echo "MANIFEST_URL='${MANIFEST_URL}'"
          if [[ -z "${MANIFEST_URL// }" ]]; then
            echo "错误：MANIFEST_URL 为空。请填入真实的 manifest 仓库 URL。"
            exit 1
          fi
          if ! echo "$MANIFEST_URL" | grep -Ei '^https?://|^git@' >/dev/null; then
            echo "错误：MANIFEST_URL 必须以 http(s):// 或 git@ 开头。 当前: $MANIFEST_URL"
            exit 1
          fi
          if echo "$MANIFEST_URL" | grep -Ei '^https?://github\.com/?$|^github\.com$|example|OWNER|MANIFEST_REPO' >/dev/null; then
            echo "错误：MANIFEST_URL 看起来像占位符或不完整地址：$MANIFEST_URL"
            exit 1
          fi
          if [[ -n "${HOUDINI_REPO// }" ]]; then
            if ! echo "$HOUDINI_REPO" | grep -Ei '^https?://|^git@' >/dev/null; then
              echo "错误：HOUDINI_REPO 必须以 http(s):// 或 git@ 开头。 当前: $HOUDINI_REPO"
              exit 1
            fi
            if echo "$HOUDINI_REPO" | grep -Ei 'example|OWNER|MANIFEST_REPO' >/dev/null; then
              echo "错误：HOUDINI_REPO 看起来像占位符或不完整地址：$HOUDINI_REPO"
              exit 1
            fi
          fi
          echo "PRUNE_REPO='${PRUNE_REPO}' (仅当为 'true' 时会删除 .repo)"
          echo "输入校验通过。"

      - name: 1. 极限腾出磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: 2. 安装 AOSP 工具链并准备 repo 二进制
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk
          mkdir -p "$HOME/bin"
          # 官方 repo 二进制（推荐），若公司网络需替换为内网镜像
          curl -fsSLo "$HOME/bin/repo" https://storage.googleapis.com/git-repo-downloads/repo
          chmod a+x "$HOME/bin/repo"
          export PATH="$HOME/bin:$PATH"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo || true
      - name: 2.1 恢复 ccache（可选）
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-bliss-ccache-${{ env.MANIFEST_BRANCH }}
          restore-keys: |
            ${{ runner.os }}-bliss-ccache-

      - name: 3. 源码同步（瘦身：仅保留 Intel/x86 相关）
        run: |
          set -euo pipefail
          rm -rf build_dir
          mkdir build_dir && cd build_dir
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"

          # repo init / sync 使用用户提供的 MANIFEST_URL
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" --depth=1
          # 使用并行下载，--partial 可根据 manifest 支持情况酌情添加以减少下载量
          repo sync -c -j"$(nproc)" --force-sync --no-clone-bundle --no-tags

          # 剔除非 Intel 代码腾出空间（按需调整）
          rm -rf device/generic/amd* vendor/amd 2>/dev/null || true
          find kernel -mindepth 1 -maxdepth 1 -not -name "x86*" -exec rm -rf {} + || true

      - name: 3.1 删除 .repo（可选，危险）
        if: ${{ env.PRUNE_REPO == 'true' }}
        run: |
          set -euo pipefail
          echo "PRUNE_REPO=true，开始删除 build_dir/.repo 以释放磁盘（此操作不可恢复）"
          cd build_dir
          # 强烈建议在第一次尝试时保留 .repo，确认构建脚本运行正常后再删除以节省空间
          rm -rf .repo || true

      - name: 4. 集成 ARM 兼容层 (Houdini)（可选）
        if: ${{ env.HOUDINI_REPO != '' }}
        run: |
          set -euo pipefail
          cd build_dir
          git clone --depth=1 --branch "$MANIFEST_BRANCH" "$HOUDINI_REPO" vendor/intel/houdini || true

      - name: 5. 针对 i1135G7 (Tiger Lake) 执行专项编译
        run: |
          set -euo pipefail
          cd build_dir

          source build/envsetup.sh

          # 启用 ccache
          export USE_CCACHE=1
          export CCACHE_DIR="${CCACHE_DIR}"
          mkdir -p "${CCACHE_DIR}"
          ccache -M 50G || true

          export TARGET_CPU_VARIANT="tigerlake"
          export BOARD_GPU_DRIVERS="iris"
          export TARGET_SURFACE=true
          export BLISS_BUILD_VARIANT="gapps"
          export TARGET_ENABLE_HOUDINI=true
          export TARGET_ENABLE_HOUDINI_64=true
          # 安全追加内核 cmdline（避免覆盖已有值）
          export BOARD_KERNEL_CMDLINE="${BOARD_KERNEL_CMDLINE:-} i915.enable_psr=0 intel_pstate=passive"

          lunch "${TARGET_PRODUCT}-${BUILD_VARIANT}"
          # 并行线程根据 runner 核心调整（若内存不足可降为 -j4）
          mka iso_img -j"$(nproc)"

      - name: 6. 保存 ccache（可选）
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-bliss-ccache-${{ env.MANIFEST_BRANCH }}
          restore-keys: |
            ${{ runner.os }}-bliss-ccache-

      - name: 7. 上传 ISO 镜像
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-17-Surface-i1135G7
          path: build_dir/out/target/product/x86_64/*.iso
          retention-days: 1
