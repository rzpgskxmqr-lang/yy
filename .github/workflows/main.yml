      - name: 4. 源码同步 (2026 语法加固与拦截修复版)
        run: |
          set -euo pipefail
          mkdir -p build_dir && cd build_dir
          
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60

          # 初始化清单
          echo "正在初始化清单并配置精简组..."
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" \
            --depth=1 \
            --partial-clone \
            --clone-filter=blob:none \
            -g "default,-arm,-mips,-darwin,-tests" || \
          repo init -u "$MANIFEST_URL" -b universe-x86 --depth=1 -g "default,-arm,-mips,-darwin,-tests"

          # 【核心拦截与冲突修复】：精准剔除无关硬件项目，并同步清理 remove-project 标签
          echo "执行源头拦截：正在剔除无关厂商并修复依赖冲突..."
          cd .repo/manifests
          python3 -c '
          import os, re
          # 核心关键字
          keywords = ["hisi", "hisilicon", "qcom", "mediatek", "mtk", "nvidia", "amlogic", "exynos", "broadcom", "yukawa"]
          if os.path.exists("default.xml"):
              with open("default.xml", "r") as f:
                  content = f.read()
              
              for kw in keywords:
                  # 使用字符串拼接构建正则，避开 Shell 对 f-string 的干扰
                  # 匹配 <project ... name="...kw..." ... />
                  p_regex = "<project\\s+[^>]*?name=\"[^\"]*?" + kw + "[^\"]*?\"[^>]*?/>"
                  content = re.sub(p_regex, "", content, flags=re.IGNORECASE | re.S)
                  
                  # 匹配 <remove-project ... name="...kw..." ... />
                  r_regex = "<remove-project\\s+[^>]*?name=\"[^\"]*?" + kw + "[^\"]*?\"[^>]*?/>"
                  content = re.sub(r_regex, "", content, flags=re.IGNORECASE | re.S)
              
              with open("default.xml", "w") as f:
                  f.write(content)
          '
          cd ../..

          # 同步源码
          echo "开始同步 (极致精简模式)..."
          repo sync -c -j4 --force-sync --no-clone-bundle --no-tags --fail-fast --retry-fetches=5
