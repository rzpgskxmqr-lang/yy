name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL'
        required: true
        default: 'github.com'
      manifest_branch:
        description: '源码分支'
        required: true
        default: 'universe-x86'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 480
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}

    steps:
      - name: 1. 极大化磁盘空间 (清理系统预装软件)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          docker-images: true
          large-packages: true
          swap-storage: true

      - name: 2. 安装必要工具链 (2026 修正版)
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk

          # 安装 repo 工具
          mkdir -p "$HOME/bin"
          curl -fsSL storage.googleapis.com > "$HOME/bin/repo"
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo

      - name: 3. 源码同步并立即回收空间 (解决磁盘满报错)
        run: |
          set -euo pipefail
          mkdir -p build_dir && cd build_dir
          
          # Git 基础身份配置
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          git config --global http.postBuffer 524288000
          
          echo "开始初始化 Repo..."
          # 使用 --partial-clone 减少初始化压力
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" --depth=1 --partial-clone --clone-filter=blob:none || \
          repo init -u "$MANIFEST_URL" -b universe-x86 --depth=1

          echo "开始同步源码 (限制并发以保证稳定性)..."
          # 使用 -j4 避免网络阻塞导致卡顿
          repo sync -c -j4 --force-sync --no-clone-bundle --no-tags

          echo "同步完成，当前磁盘占用情况："
          df -h .

          # 【核心步骤】：立即删除 .repo 目录
          # .repo 目录仅用于同步，编译时不再需要。删除它可释放 100GB+ 空间
          echo "正在执行紧急空间回收：删除 .repo 目录..."
          rm -rf .repo

          # 删除不属于 Intel 平台的冗余代码（针对 i1135G7 瘦身）
          rm -rf device/generic/amd* vendor/amd 2>/dev/null || true
          
          echo "清理后的磁盘空间："
          df -h .

      - name: 4. 执行 Surface i1135G7 专项优化编译
        run: |
          set -euo pipefail
          cd build_dir
          
          # 针对 Tiger Lake (i1135G7) 核心优化
          # 增加虚拟内存限制防止编译时 OOM 崩溃
          /bin/bash -c "source build/envsetup.sh && \
          export TARGET_CPU_VARIANT='tigerlake' && \
          export BOARD_GPU_DRIVERS='iris' && \
          export TARGET_SURFACE=true && \
          export BLISS_BUILD_VARIANT='gapps' && \
          lunch bliss_x86_64-userdebug && \
          mka iso_img -j$(nproc)"

      - name: 5. 检查并上传编译结果
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-17-Surface-i1135G7
          path: build_dir/out/target/product/x86_64/*.iso
          retention-days: 7
