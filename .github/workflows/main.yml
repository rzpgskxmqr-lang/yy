name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL'
        required: true
        # 修正建议：启动时请输入 github.com
        default: 'github.com'
      manifest_branch:
        description: '源码分支'
        required: true
        # 【核心修正】：默认值改为远程存在的 universe-x86
        default: 'universe-x86'
      prune_repo:
        description: '清理磁盘释放空间 (必须填 true)'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 验证输入合法性
        run: |
          set -euo pipefail
          if [[ "$MANIFEST_URL" == "github.com" || -z "$MANIFEST_URL" ]]; then
            echo "错误：请填写完整的 https 仓库地址，不能只填 github.com"
            exit 1
          fi

      - name: 2. 极大化磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true

      - name: 3. 安装工具链与修复 Repo (2026 路径修正版)
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk

          mkdir -p "$HOME/bin"
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > "$HOME/bin/repo"
          
          if grep -q "<!DOCTYPE html>" "$HOME/bin/repo"; then
            echo "Google 源不可用，切换至 GitHub Raw 原始脚本路径..."
            curl -fsSL raw.githubusercontent.com > "$HOME/bin/repo"
          fi
          
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo || true

      - name: 4. 源码同步 (2026 自动识别排除修复版)
        run: |
          mkdir build_dir && cd build_dir
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          
          # 仅同步 ART 及核心组件，排除 arm/nvidia 等硬件代码
          repo init -u ${{ github.event.inputs.manifest_url }} -b ${{ github.event.inputs.manifest_branch }} --depth=1 \
            -g default,art,x86,intel -pdk,-vts,-arm,-amd,-nvidia
          
          # 物理屏蔽故障路径
          find .repo/manifests -name "*.xml" -exec sed -i '/vendor\/prebuilts/d' {} +
          
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags --detach

      - name: 4. 注入发热优化与转译层配置
        run: |
          cd build_dir
          # 预创建 system 目录用于注入属性
          mkdir -p out/target/product/x86_64/system/
          
          # 写入温控优化属性：调高 JIT 门槛，降低后台编译强度
          {
            echo "# ART Thermal & Energy Optimization"
            echo "dalvik.vm.dex2oat-threads=2"        # 后台编译限制为 2 线程
            echo "dalvik.vm.boot-dex2oat-threads=4"   # 开机编译限制为 4 线程
            echo "dalvik.vm.jitthreshold=5120"        # 减少 JIT 编译器活动频率
            echo "ro.dalvik.vm.native.bridge=libhoudini.so"
            echo "pm.dexopt.bg-dexopt=speed-profile"  # 后台优化改为省电模式
          } >> out/target/product/x86_64/system/build.prop
          
          # 开启 ARM 架构支持声明
          mkdir -p device/generic/common/
          echo "PRODUCT_ABI_LIST_EXTRA := armeabi-v7a, armeabi, arm64-v8a" >> device/generic/common/device.mk

      - name: 5. 针对 i1135G7 执行温控优化编译
        run: |
          cd build_dir
          source build/envsetup.sh
          
          # 选择 x86_64 目标
          lunch bliss_x86_64-userdebug || lunch aosp_x86_64-userdebug
          
          # --- 编译时优化变量 ---
          export TARGET_CPU_VARIANT='tigerlake'      # 启用 TigerLake 优化指令
          export DEX2OAT_THREADS=4                   # 限制编译时的最大核心占用
          export ART_DEX2OAT_METHODS_FOR_COMPILATION=speed-profile # 性能与功耗平衡策略
          export TARGET_HAS_NATIVEBRIDGE=true        # 启用转译层支持
          
          echo "开始编译针对 i1135G7 优化的 ART 模块..."
          m com.android.art

      - name: 6. 上传 ART 优化产物
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ART-TigerLake-Thermal-Optimized
          path: |
            build_dir/out/target/product/x86_64/system/apex/com.android.art.apex
            build_dir/out/target/product/x86_64/apex/com.android.art.apex
          retention-days: 7
         
