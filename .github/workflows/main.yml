
name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL (需包含 https://)'
        required: true
        default: 'github.com'
      manifest_branch:
        description: '源码分支 (2026常用: v17.x, android-15)'
        required: true
        default: 'v17.x'
      prune_repo:
        description: '清理磁盘释放空间 (必须填 true)'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 480
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 极大化磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          # 2026年编译安卓15至少需要 150GB+ 空间
          swap-storage: true 

      - name: 2. 安装 2026 标准工具链
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk

          # 修复 Repo 工具下载路径
          mkdir -p "$HOME/bin"
          curl -fsSL storage.googleapis.com > "$HOME/bin/repo"
          
          # 备用下载路径 (如果 Google 被墙或链接失效)
          if [ ! -s "$HOME/bin/repo" ] || grep -q "<!DOCTYPE html>" "$HOME/bin/repo"; then
            curl -fsSL raw.githubusercontent.com > "$HOME/bin/repo"
          fi
          
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo

      - name: 3. 源码同步 (多分支兼容逻辑)
        run: |
          set -euo pipefail
          mkdir build_dir && cd build_dir
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          
          # 核心修复：自动尝试不同的大小写和命名规范
          SUCCESS=false
          for BRANCH in "$MANIFEST_BRANCH" "v17.x" "android-15" "ruby-v17.x"; do
            echo "尝试初始化分支: $BRANCH"
            if repo init -u "$MANIFEST_URL" -b "$BRANCH" --depth=1; then
              SUCCESS=true
              echo "成功匹配分支: $BRANCH"
              break
            fi
            rm -rf .repo # 初始化失败必须清理，否则下次尝试会报错
          done

          if [ "$SUCCESS" = false ]; then
            echo "错误：无法获取有效的远程分支，请检查 Manifest URL 或分支名。"
            exit 1
          fi
          
          # 同步源码，减少并发以防止 GitHub 断连
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

      - name: 4. 释放磁盘空间 (针对 Intel 平台瘦身)
        run: |
          set -euo pipefail
          cd build_dir
          # 物理删除不相关的代码（如 AMD 驱动和非 x86 固件）
          rm -rf device/generic/amd* vendor/amd 2>/dev/null || true
          
          if [[ "$PRUNE_REPO" == "true" ]]; then
            echo "清理 .repo 目录以确保有足够空间进行编译生成..."
            rm -rf .repo
          fi

      - name: 5. 针对 Surface i1135G7 (Tiger Lake) 执行编译
        run: |
          set -euo pipefail
          cd build_dir
          source build/envsetup.sh
          
          # 2026年针对 11 代酷睿 Iris Xe 的专项参数
          export TARGET_CPU_VARIANT="tigerlake"
          export BOARD_GPU_DRIVERS="iris"
          export TARGET_SURFACE=true
          export BLISS_BUILD_VARIANT="gapps"
          
          # 修复 Surface 屏幕闪烁与电源管理
          export BOARD_KERNEL_CMDLINE="${BOARD_KERNEL_CMDLINE:-} i915.enable_psr=0 intel_pstate=passive"
          
          lunch bliss_x86_64-userdebug
          mka iso_img -j$(nproc)

      - name: 6. 上传 ISO 镜像
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-17-Surface-i1135G7
          path: build_dir/out/target/product/x86_64/*.iso
          retention-days: 1
