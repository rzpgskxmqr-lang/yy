name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL'
        required: true
        # 修正建议：启动时请输入 github.com
        default: 'github.com'
      manifest_branch:
        description: '源码分支'
        required: true
        # 【核心修正】：默认值改为远程存在的 universe-x86
        default: 'universe-x86'
      prune_repo:
        description: '清理磁盘释放空间 (必须填 true)'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 验证输入合法性
        run: |
          set -euo pipefail
          if [[ "$MANIFEST_URL" == "github.com" || -z "$MANIFEST_URL" ]]; then
            echo "错误：请填写完整的 https 仓库地址，不能只填 github.com"
            exit 1
          fi

      - name: 2. 极大化磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true

      - name: 3. 安装工具链与修复 Repo (2026 路径修正版)
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk

          mkdir -p "$HOME/bin"
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > "$HOME/bin/repo"
          
          if grep -q "<!DOCTYPE html>" "$HOME/bin/repo"; then
            echo "Google 源不可用，切换至 GitHub Raw 原始脚本路径..."
            curl -fsSL raw.githubusercontent.com > "$HOME/bin/repo"
          fi
          
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo || true
          
      - name: 4. 源码同步 (2026 组排除稳健版)
        run: |
          set -euo pipefail
          mkdir -p build_dir && cd build_dir
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          
          # 1. 【排除庞大组件的核心】：在 -g 参数中使用减号排除不需要的组
          # 这样在下载阶段就会跳过：预编译(pdk/vts/vndk)、AMD、Nvidia、ARM、高通等不相关厂商内容
          echo "开始初始化并排除非必要组件..."
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" --depth=1 \
            -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm || \
          repo init -u "$MANIFEST_URL" -b master --depth=1 \
            -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm
          
          # 2. 【核心修复】：彻底删除 local_manifests 目录
          # 2026 版 Repo 对 remove-project 校验极严，只要清单里不存在就会报错。
          # 既然上面 -g 已经排除了一大部分，剩余的故障仓库我们直接物理删除。
          rm -rf .repo/local_manifests || true
          
          # 3. 清理锁文件
          find .repo -name "*.lock" -delete || true
          
          # 4. 执行同步
          # --detach: 强制解决 refs/heads/universe 找不到的问题
          echo "开始同步（已开启默认强制继续模式）..."
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags --detach || \
          repo sync -c -j1 --force-sync --no-clone-bundle --no-tags --detach

          # 5. 【手动排除】：同步后物理删除特定的故障目录，绕过 XML 校验报错
          rm -rf vendor/prebuilts

      - 

          # 5. 【手动排除】：同步完如果产生了 vendor/prebuilts 故障目录，直接物理删除
          rm -rf vendor/prebuilts
          set -euo pipefail
          mkdir -p build_dir && cd build_dir
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          
          # 初始化：优先使用 universe-x86，并排除庞大的预编译/厂商组
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" --depth=1 -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm || \
          repo init -u "$MANIFEST_URL" -b universe-x86 --depth=1 -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm || \
          repo init -u "$MANIFEST_URL" -b master --depth=1 -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm
          
          # 【核心修复】：使用 printf 确保生成格式正确的 XML，彻底解决 "no element found" 报错
          mkdir -p .repo/local_manifests
          
          # 动态获取清单中匹配 vendor/prebuilts 的项目，若获取失败则使用默认值
          REAL_PROJ_NAME=$(repo list -n | grep "vendor/prebuilts" || echo "platform/vendor/prebuilts")
          
          printf '<?xml version="1.0" encoding="UTF-8"?>\n<manifest>\n  <remove-project name="%s" />\n</manifest>\n' "$REAL_PROJ_NAME" > .repo/local_manifests/remove_broken.xml
          echo "检测到并自动排除项目: $REAL_PROJ_NAME"
          
          # 清理锁文件并强制同步
          find .repo -name "*.lock" -delete || true
          
          # --detach: 强制忽略不匹配的分支引用
          # --force-sync: 强制修复 Shared project 冲突
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags --detach || \
          repo sync -c -j1 --force-sync --no-clone-bundle --no-tags --detach

      - name: 5. 释放磁盘空间 (针对 i1135G7 瘦身)
        run: |
          set -euo pipefail
          cd build_dir
          # 物理删除所有非 Intel 厂商的设备和供应商文件夹
          rm -rf device/generic/amd* vendor/amd 2>/dev/null || true
          rm -rf vendor/nvidia* vendor/qualcomm* 2>/dev/null || true
          
          if [[ "$PRUNE_REPO" == "true" ]]; then
            echo "正在删除 .repo 以释放约 150GB 空间完成打包..."
            rm -rf .repo
          fi

      - name: 6. 针对 Surface i1135G7 执行专项优化编译
        run: |
          set -euo pipefail
          cd build_dir
          # 显式使用 bash 执行 source 以确保环境加载正确
          /bin/bash -c "source build/envsetup.sh && \
          export TARGET_CPU_VARIANT='tigerlake' && \
          export BOARD_GPU_DRIVERS='iris' && \
          export TARGET_SURFACE=true && \
          export BLISS_BUILD_VARIANT='gapps' && \
          export BOARD_KERNEL_CMDLINE='${BOARD_KERNEL_CMDLINE:-} i915.enable_psr=0 intel_pstate=passive' && \
          lunch bliss_x86_64-userdebug && \
          mka iso_img -j$(nproc)"

      - name: 7. 上传结果
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-17-Surface-i1135G7
          path: build_dir/out/target/product/x86_64/*.iso
          retention-days: 1
