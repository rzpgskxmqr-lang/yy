name: Build BlissOS 14.x (Android 11) FOSS
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: 腾出磁盘空间 (白嫖核心步骤)
        # GitHub Runner 默认空间不足，必须清理预装软件以获得约 30GB 空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo docker image prune -a -f || true
          echo "Disk space cleared"
          df -h

      - name: 安装编译环境依赖
        # 官方文档要求的编译依赖项
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential curl git gnupg gperf libxml2-utils make python3 zip zlib1g-dev libssl-dev ccache xmlstarlet gettext xorriso genisoimage

      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: 初始化并同步源码 (选择 14.x 分支)
        # 这是官方 Manifest 地址
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          mkdir bliss && cd bliss
          repo init -u github.com -b r-x86-14.x # 使用这个分支来编译 Android 11
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

      - name: 开始编译 ISO 镜像
        # 配置为 FOSS (自由开源应用) 并开始制作可启动 ISO
        run: |
          cd bliss
          source build/envsetup.sh
          export BLISS_BUILD_VARIANT=foss # 构建 FOSS 版本，节省空间和时间
          lunch android_x86_64-userdebug
          make iso_img -j$(nproc --all) # 生成 ISO 文件

      - name: 上传生成的 ISO 成品
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-x86_64-FOSS
          path: bliss/out/target/product/x86_64/*.iso
