name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL'
        required: true
        # 修正建议：启动时请输入 github.com
        default: 'github.com'
      manifest_branch:
        description: '源码分支'
        required: true
        # 【核心修正】：默认值改为远程存在的 universe-x86
        default: 'universe-x86'
      prune_repo:
        description: '清理磁盘释放空间 (必须填 true)'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 验证输入合法性
        run: |
          set -euo pipefail
          if [[ "$MANIFEST_URL" == "github.com" || -z "$MANIFEST_URL" ]]; then
            echo "错误：请填写完整的 https 仓库地址，不能只填 github.com"
            exit 1
          fi

      - name: 2. 极大化磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true

      - name: 3. 安装工具链与修复 Repo (2026 路径修正版)
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk

          mkdir -p "$HOME/bin"
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > "$HOME/bin/repo"
          
          if grep -q "<!DOCTYPE html>" "$HOME/bin/repo"; then
            echo "Google 源不可用，切换至 GitHub Raw 原始脚本路径..."
            curl -fsSL raw.githubusercontent.com > "$HOME/bin/repo"
          fi
          
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo || true

      - name: 4. 源码同步 (2026 自动识别排除修复版)
        run: |
          
          set -euo pipefail
          mkdir -p build_dir && cd build_dir
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          
          # 1. 【初始化减负】
          echo "正在初始化并执行初步减负..."
          # 这里先执行 init 即使报错也不退出（因为我们要先拿到脚本文件才能修复）
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" --depth=1 \
            -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm || \
          repo init -u "$MANIFEST_URL" -b universe-x86 --depth=1 \
            -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm || \
          repo init -u "$MANIFEST_URL" -b master --depth=1 \
            -g default,-pdk,-vts,-vndk,-amd,-nvidia,-arm,-qualcomm || true

          # 2. 【核心修复】：物理抹除导致 Python 3.12 崩溃的 Logger 参数
          # 解决：TypeError: Logger._log() got an unexpected keyword argument 'file'
          echo "正在对 Repo 内部脚本进行 Python 3.12 兼容性热补丁..."
          if [ -d ".repo/repo" ]; then
            find .repo/repo -name "*.py" -exec sed -i 's/, file=sys.stderr//g' {} +
            echo "补丁应用成功。"
          fi

          # 3. 【强硬抹除策略】：物理删除故障仓库定义
          echo "执行物理级清单阉割，强制抹除故障项目..."
          find .repo/manifests -name "*.xml" -exec sed -i '/vendor\/prebuilts/d' {} +
          find .repo/manifest.xml -exec sed -i '/vendor\/prebuilts/d' {} + || true

          # 4. 【清空干扰与清理锁】
          rm -rf .repo/local_manifests/*.xml || true
          find .repo -name "*.lock" -delete || true

          # 5. 【执行强制同步】
          echo "开始执行减负同步..."
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags --detach || \
          repo sync -c -j1 --force-sync --no-clone-bundle --no-tags --detach
           
          # 6. 【物理补全核心脚本】（保持你的原有逻辑）
          if [ ! -f "build/blueprint/microfactory/microfactory.bash" ]; then
            echo "检测到核心脚本缺失，正在物理补全..."
            git clone --depth=1 https://android.googlesource.com/platform/build/blueprint build/blueprint || true
          fi
          if [ ! -d "prebuilts/go/linux-x86" ]; then
            mkdir -p prebuilts/go
            git clone --depth=1 https://android.googlesource.com/platform/prebuilts/go/linux-x86 prebuilts/go/linux-x86 || true
          fi
          if [ ! -d "prebuilts/bazel/common" ]; then
            mkdir -p prebuilts/bazel
            git clone --depth=1 https://android.googlesource.com/platform/prebuilts/bazel/common prebuilts/bazel/common || true
          fi
          
          # 7. 最后确认清理
          rm -rf vendor/prebuilts

          

      -       - name: 6. 针对 Surface i1135G7 执行 ART 专项温控编译 (Android 13 适配版)
        run: | 
          # 进入源码目录并加载环境
          cd build_dir
          source build/envsetup.sh
          
          # --- 自动探测并执行 Lunch ---
          echo "正在搜索适配 Android 13 的 x86_64 编译组合..."
          # 优先级：Bliss 官方名 -> 通用安卓名 -> AOSP 名 -> 自动过滤列表
          lunch bliss_x86_64-userdebug || \
          lunch android_x86_64-userdebug || \
          lunch aosp_x86_64-userdebug || \
          {
              echo "常规命名失败，尝试从系统列表中提取有效 x86_64 组合..."
              # 自动抓取包含 x86_64 的 userdebug 组合
              AUTO_COMBO=$(lunch 2>&1 | grep -i "x86_64" | grep "userdebug" | head -n 1 | awk '{print $1}' | sed 's/^[ \t]*//')
              if [ -z "$AUTO_COMBO" ]; then
                echo "错误：无法自动识别 x86_64 编译目标，请检查设备树(Device Tree)是否同步完整。"
                exit 1
              fi
              echo "自动探测到组合: $AUTO_COMBO"
              lunch "$AUTO_COMBO"
          }

          # --- 注入 i1135G7 (Tiger Lake) 专项优化环境变量 ---
          # 1. 指令集优化：利用 11 代酷睿架构优势
          export TARGET_CPU_VARIANT='tigerlake'
          
          # 2. 发热优化：限制编译线程防止 Runner 崩溃，同时设定运行时的温控基准
          export DEX2OAT_THREADS=4 
          export ART_DEX2OAT_METHODS_FOR_COMPILATION=speed-profile
          
          # 3. 运行环境调校：写入 build.prop 降低 Surface 运行时 JIT 负载
          mkdir -p out/target/product/x86_64/system/
          {
            echo "# ART Optimized for i1135G7"
            echo "dalvik.vm.jitthreshold=5120"        # 提升 JIT 门槛，减少背景热量
            echo "dalvik.vm.dex2oat-threads=2"        # 后台优化限制为双线程
            echo "ro.dalvik.vm.native.bridge=libhoudini.so"
          } >> out/target/product/x86_64/system/build.prop

          # --- 执行 ART 模块编译 ---
          # Android 13 标准下，ART 是核心 Mainline 模块
          echo "开始编译针对 i1135G7 优化的 ART APEX 模块..."
          m com.android.art -j4

      - name: 7. 整理并上传优化后的产物
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ART-Optimized-TigerLake-Android13
          path: |
            build_dir/out/target/product/x86_64/system/apex/com.android.art.apex
            build_dir/out/target/product/x86_64/apex/com.android.art.apex
            build_dir/out/target/product/x86_64/system/build.prop
          retention-days: 7

      - name: 8. 磁盘空间清理 (防止退出报错)
        if: always()
        run: |
          # 编译完成后清理临时对象，确保 Artifact 上传有足够 buffer
          rm -rf build_dir/out/target/product/x86_64/obj

        
