name: Build BlissOS 17 (Surface i1135G7 2026-Final)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: '完整的 Manifest URL'
        required: true
        default: 'github.com'
      manifest_branch:
        description: '源码分支'
        required: true
        default: 'universe-x86'
      prune_repo:
        description: '同步后删除 .repo 文件夹以释放空间 (建议设为 true)'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 480
    env:
      MANIFEST_URL: ${{ github.event.inputs.manifest_url }}
      MANIFEST_BRANCH: ${{ github.event.inputs.manifest_branch }}
      PRUNE_REPO: ${{ github.event.inputs.prune_repo }}

    steps:
      - name: 1. 验证输入合法性
        run: |
          set -euo pipefail
          if [[ "$MANIFEST_URL" == "github.com" || -z "$MANIFEST_URL" ]]; then
            echo "错误：请填写完整的 https 仓库地址！"
            exit 1
          fi

      - name: 2. 极大化磁盘空间 (2026 核心步骤)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          docker-images: true
          large-packages: true

      - name: 3. 安装工具链与修复 Repo
        run: |
          set -euo pipefail
          sudo apt update
          sudo apt install -y bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git git-lfs gnupg gperf lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libsdl1.2-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 \
            python3-setuptools openjdk-17-jdk

          mkdir -p "$HOME/bin"
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > "$HOME/bin/repo"
          chmod a+x "$HOME/bin/repo"
          sudo ln -sf "$HOME/bin/repo" /usr/bin/repo

      - name: 4. 源码同步与即时深度瘦身 (边同步边瘦身版)
        run: |
          set -euo pipefail
          mkdir -p build_dir && cd build_dir
          
          # Git 极致空间优化配置
          git config --global user.email "build@bliss.com"
          git config --global user.name "Builder"
          git config --global http.postBuffer 524288000
          
          # 初始化 - 使用 blob:none 过滤所有历史记录，仅拉取当前代码
          echo "Starting Repo Init (Extreme Sparse Mode)..."
          repo init -u "$MANIFEST_URL" -b "$MANIFEST_BRANCH" --depth=1 --partial-clone --clone-filter=blob:none || \
          repo init -u "$MANIFEST_URL" -b universe-x86 --depth=1 --partial-clone --clone-filter=blob:none
          
          # 同步 - 限制并发防止峰值流量导致的临时文件堆积
          echo "Starting Repo Sync (This may take a while)..."
          repo sync -c -j4 --force-sync --no-clone-bundle --no-tags --fail-fast
          
          echo "=== 同步完成，立即开始深度瘦身以腾出编译空间 ==="
          
          # 1. 移除巨型非核心组件 (如 WebView 约 5GB+)
          rm -rf external/chromium-webview 2>/dev/null || true
          
          # 2. 精简字体库：仅保留中文 (CJK) 和 英文 (Roboto)
          if [ -d "external/noto-fonts" ]; then
            echo "正在保留中英文字体..."
            mkdir -p ../temp_fonts
            mv external/noto-fonts/cjk ../temp_fonts/ 2>/dev/null || true
            mv external/roboto-fonts ../temp_fonts/ 2>/dev/null || true
            rm -rf external/noto-fonts/* 2>/dev/null || true
            mv ../temp_fonts/cjk external/noto-fonts/ 2>/dev/null || true
            mv ../temp_fonts/roboto-fonts external/ 2>/dev/null || true
            rm -rf ../temp_fonts
          fi
          
          # 3. 删除不相关的驱动 (AMD/Linaro)
          rm -rf device/generic/amd* vendor/amd 2>/dev/null || true
          rm -rf device/linaro 2>/dev/null || true
          
          # 4. 【救命步】删除 .repo 缓存 (释放约 150GB 空间)
          if [[ "$PRUNE_REPO" == "true" ]]; then
            echo "紧急释放磁盘空间：正在彻底删除 .repo 目录..."
            rm -rf .repo
          fi

          # 5. 清理 Git 历史冗余 (额外释放 10GB+ 空间)
          echo "正在清理子仓库 Git 冗余..."
          find . -name ".git" -type d -exec rm -rf {} + || true
          
          echo "=== 空间准备就绪 ==="
          df -h .

      - name: 5. 针对 Surface i1135G7 执行专项优化编译
        run: |
          set -euo pipefail
          cd build_dir
          # 使用 Tigerlake (i1135G7) 架构优化参数
          /bin/bash -c "source build/envsetup.sh && \
          export TARGET_CPU_VARIANT='tigerlake' && \
          export BOARD_GPU_DRIVERS='iris' && \
          export TARGET_SURFACE=true && \
          export BLISS_BUILD_VARIANT='gapps' && \
          lunch bliss_x86_64-userdebug && \
          mka iso_img -j$(nproc)"

      - name: 6. 上传结果
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: BlissOS-17-Surface-i1135G7
          path: build_dir/out/target/product/x86_64/*.iso
          retention-days: 7
