name: Build Optimized ART for Surface Pro 8
on: workflow_dispatch
jobs:
  build-art:
    runs-on: ubuntu-22.04
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune -a -f
      - name: Setup Repo
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
      - name: Sync ART Source
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          mkdir bliss_art && cd bliss_art
          # 核心：只同步编译 ART 所需的必要项目 (使用 -c 和 --depth=1)
          repo init -u https://github.com/BlissOS/manifest.git -b r60 --depth=1 --no-clone-bundle
          # 仅同步关键目录以节省空间
          repo sync -c -j4 art bionic libcore libnativehelper build/make system/core --no-tags --no-clone-bundle
      - name: Build ART with Surface Pro 8 (Tiger Lake) Optimizations
        run: |
          cd bliss_art
          . build/envsetup.sh
          lunch bliss_x86_64-userdebug
          
          # 注入针对 Surface Pro 8 (Tiger Lake) 的编译器优化
          export TARGET_CPU_VARIANT=tigerlake
          export TARGET_ARCH_VARIANT=x86_64
          
          # 编译 ART 模块 (APEX)
          m com.android.art
          
      - name: Upload ART Module
        uses: actions/upload-artifact@v4
        with:
          name: ART-Module-Surface-Pro8
          path: bliss_art/out/target/product/x86_64/system/apex/com.android.art.apex
